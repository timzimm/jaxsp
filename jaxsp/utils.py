import builtins
from functools import wraps, partial
from typing import Any, Callable, TypeVar
from collections.abc import Sequence

import jax
from jax.tree_util import tree_unflatten, tree_flatten, tree_map
from jax.lax import cond
import jax.numpy as jnp


T = TypeVar("T")
F = TypeVar("F", bound=Callable[..., Any])


def _tree_map_multi_output(f, *args):
    """Like tree_map, but for functions that return tuples."""
    leaves, treedefs = zip(*builtins.map(tree_flatten, args))
    if any(treedef != treedefs[0] for treedef in treedefs):
        raise ValueError(f"argument treedefs do not match {treedefs=}")
    outputs = zip(*builtins.map(f, *leaves))
    return tuple(tree_unflatten(treedefs[0], out) for out in outputs)


def _lax_map(f, *xs):
    """Like lax.map, but supports multiple arguments like the built-in map."""
    _, ys = jax.lax.scan(lambda _, x: ((), f(*x)), (), xs)
    return ys


def map_vmap(
    f: F,
    in_axes: int | None | Sequence[Any] = 0,
    out_axes: Any = 0,
    *,
    batch_size: int,
) -> F:
    """jax.vmap, but looping when the batch dimension exceeds batch_size."""

    def preprocess(x, in_axis):
        batch_count = x.shape[in_axis] // batch_size
        x = jax.numpy.moveaxis(x, in_axis, 0)
        loop_elements = batch_count * batch_size
        x_loop = x[:loop_elements].reshape((batch_count, batch_size) + x.shape[1:])
        x_tail = x[loop_elements:]
        return x_loop, x_tail

    def postprocess(x_loop, x_tail, out_axis):
        shape = x_loop.shape
        x_loop = x_loop.reshape((shape[0] * shape[1],) + shape[2:])
        x = jax.numpy.concatenate([x_loop, x_tail], axis=0)
        return jax.numpy.moveaxis(x, 0, out_axis)

    @wraps(f)
    def _batch_vmap_wrapper(*args):
        if isinstance(in_axes, int) or in_axes is None:
            in_axes_tuple = (in_axes,) * len(args)
        else:
            in_axes_tuple = tuple(in_axes)

        broadcasts_args: list[Any] = []
        batched_args: list[Any] = []
        remainder_args: list[Any] = []

        for i, (arg, in_axis) in enumerate(zip(args, in_axes_tuple)):
            if in_axis is None:
                broadcasts_args.append((i, arg))
            elif isinstance(in_axis, int):
                loop_arg, tail_arg = _tree_map_multi_output(
                    partial(preprocess, in_axis=in_axis), arg
                )
                batched_args.append(loop_arg)
                remainder_args.append(tail_arg)
            else:
                loop_arg, tail_arg = _tree_map_multi_output(preprocess, arg, in_axis)
                batched_args.append(loop_arg)
                remainder_args.append(tail_arg)

        def vmap_f(*args):
            args2 = list(args)
            for i, arg in broadcasts_args:
                args2.insert(i, arg)
            return f(*args2)

        loop_out = _lax_map(jax.vmap(vmap_f), *batched_args)
        tail_out = jax.vmap(vmap_f)(*remainder_args)
        if isinstance(out_axes, int):
            out = tree_map(partial(postprocess, out_axis=out_axes), loop_out, tail_out)
        else:
            out = tree_map(postprocess, loop_out, tail_out, out_axes)
        return out

    return _batch_vmap_wrapper  # type: ignore


_glx128 = jnp.array(
    [
        8.755602643406579e-05,
        0.000461270011312076,
        0.0011333756872429768,
        0.0021036207325094147,
        0.003371443549893549,
        0.004936090754132816,
        0.006796628637706914,
        0.008951945782140758,
        0.01140075426804632,
        0.014141590626431721,
        0.017172816784017386,
        0.02049262107315003,
        0.02409901932936781,
        0.027989856084889908,
        0.03216280586104181,
        0.03661537456052605,
        0.041344900959519704,
        0.0463485582991216,
        0.05162335597542089,
        0.05716614132730141,
        0.06297360152098408,
        0.06904226553022574,
        0.07536850621101554,
        0.08194854246954658,
        0.08877844152217806,
        0.09585412124604314,
        0.10317135261890337,
        0.11072576224679404,
        0.11851283497795262,
        0.126527916601469,
        0.1347662166290456,
        0.1432228111582063,
        0.1518926458152428,
        0.1607705387761404,
        0.16985118386367698,
        0.17912915371884625,
        0.18859890304470756,
        0.19825477192072571,
        0.20809098918561847,
        0.21810167588669094,
        0.22828084879359484,
        0.23862242397441225,
        0.24912022043192777,
        0.259767963797914,
        0.2705592900832239,
        0.28148774948144795,
        0.29254681022386253,
        0.3037298624833663,
        0.3150302223250705,
        0.3264411357011823,
        0.33795578248779334,
        0.3495672805611614,
        0.36126868991104777,
        0.3730530167886529,
        0.38491321788667,
        0.3968422045489604,
        0.4088328470073314,
        0.42087797864288756,
        0.4329704002694061,
        0.4451028844361781,
        0.45726817974774225,
        0.4694590151979302,
        0.48166810451563324,
        0.4938881505196921,
        0.5061118494803079,
        0.5183318954843668,
        0.5305409848020698,
        0.5427318202522577,
        0.5548971155638218,
        0.5670295997305939,
        0.5791220213571124,
        0.5911671529926685,
        0.6031577954510396,
        0.61508678211333,
        0.6269469832113471,
        0.6387313100889522,
        0.6504327194388386,
        0.6620442175122067,
        0.6735588642988177,
        0.6849697776749295,
        0.6962701375166337,
        0.7074531897761375,
        0.718512250518552,
        0.7294407099167761,
        0.740232036202086,
        0.7508797795680722,
        0.7613775760255878,
        0.7717191512064052,
        0.7818983241133091,
        0.7919090108143816,
        0.8017452280792743,
        0.8114010969552925,
        0.8208708462811538,
        0.8301488161363231,
        0.8392294612238596,
        0.8481073541847572,
        0.8567771888417937,
        0.8652337833709545,
        0.873472083398531,
        0.8814871650220474,
        0.8892742377532059,
        0.8968286473810967,
        0.9041458787539569,
        0.9112215584778219,
        0.9180514575304535,
        0.9246314937889845,
        0.9309577344697743,
        0.9370263984790159,
        0.9428338586726985,
        0.9483766440245791,
        0.9536514417008783,
        0.9586550990404803,
        0.963384625439474,
        0.9678371941389582,
        0.9720101439151101,
        0.9759009806706322,
        0.97950737892685,
        0.9828271832159826,
        0.9858584093735683,
        0.9885992457319537,
        0.9910480542178592,
        0.9932033713622931,
        0.9950639092458672,
        0.9966285564501065,
        0.9978963792674906,
        0.9988666243127571,
        0.999538729988688,
        0.9999124439735659,
    ]
)
_glx256 = jnp.array(
    [
        2.1974990503881298e-05,
        0.00011578129536837789,
        0.0002845312668692812,
        0.0005282370782955792,
        0.0008468667634967675,
        0.00124037362163959,
        0.0017086989883092207,
        0.00225177275945182,
        0.0028695135387951654,
        0.0035618286955889644,
        0.004328614396208463,
        0.0051697556274674095,
        0.006085126217569681,
        0.007074588856937014,
        0.008137995119842256,
        0.0092751854872678,
        0.010485989371188997,
        0.01177022514038295,
        0.01312770014781478,
        0.014558210759628487,
        0.016061542385755245,
        0.017637469512146786,
        0.019285755734633925,
        0.021006153794410953,
        0.022798405615141903,
        0.024662242341685847,
        0.02659738438043624,
        0.028603541441268754,
        0.03068041258109261,
        0.032827686248998456,
        0.03504504033299716,
        0.03733214220834191,
        0.03968864878742673,
        0.04211420657125481,
        0.04460845170246752,
        0.047171010019927684,
        0.049801497114848214,
        0.05249951838845773,
        0.05526466911119454,
        0.058096534483420836,
        0.06099468969764671,
        0.06395870000225584,
        0.06698812076672273,
        0.0700824975483118,
        0.07324136616024851,
        0.07646425274135188,
        0.07975067382711865,
        0.08310013642224756,
        0.08651213807459374,
        0.08998616695054146,
        0.09352170191178422,
        0.09711821259350067,
        0.10077515948391463,
        0.10449199400522702,
        0.1082681585959081,
        0.11210308679433711,
        0.11599620332377719,
        0.11994692417867225,
        0.12395465671225397,
        0.12801879972544422,
        0.13213874355704108,
        0.13631387017517393,
        0.14054355327001428,
        0.14482715834772836,
        0.14916404282565743,
        0.15355355612871152,
        0.157995039786962,
        0.1624878275344186,
        0.16703124540897574,
        0.1716246118535134,
        0.17626723781813758,
        0.1809584268635443,
        0.18569747526549252,
        0.19048367212036937,
        0.19531629945183304,
        0.20019463231851586,
        0.20511793892277286,
        0.21008548072045852,
        0.21509651253171563,
        0.22015028265275943,
        0.2252460329686407,
        0.2303829990669704,
        0.23556041035258884,
        0.24077749016316274,
        0.24603345588569198,
        0.25132751907390927,
        0.2566588855665548,
        0.26202675560650834,
        0.26743032396076033,
        0.27286878004120496,
        0.27834130802623636,
        0.2838470869831293,
        0.2893852909911881,
        0.29495508926564173,
        0.30055564628227044,
        0.3061861219027422,
        0.3118456715006418,
        0.317533446088173,
        0.323248592443515,
        0.32899025323881415,
        0.3347575671687915,
        0.3405496690799469,
        0.34636569010034046,
        0.3522047577699322,
        0.3580659961714591,
        0.3639485260618317,
        0.36985146500402877,
        0.3757739274994717,
        0.381715025120858,
        0.387673866645434,
        0.393649558188687,
        0.39964120333843667,
        0.40564790328930556,
        0.411668756977549,
        0.4177028612162231,
        0.4237493108306718,
        0.42980719879431206,
        0.43587561636469646,
        0.4419536532198336,
        0.4480403975947453,
        0.4541349364182402,
        0.4602363554498835,
        0.4663437394171418,
        0.472456172152683,
        0.47857273673181044,
        0.4846925156100105,
        0.4908145907605932,
        0.49693804381240525,
        0.5030619561875947,
        0.5091854092394068,
        0.5153074843899895,
        0.5214272632681896,
        0.527543827847317,
        0.5336562605828582,
        0.5397636445501165,
        0.5458650635817598,
        0.5519596024052547,
        0.5580463467801664,
        0.5641243836353036,
        0.5701928012056879,
        0.5762506891693282,
        0.582297138783777,
        0.588331243022451,
        0.5943520967106944,
        0.6003587966615633,
        0.606350441811313,
        0.612326133354566,
        0.618284974879142,
        0.6242260725005283,
        0.6301485349959712,
        0.6360514739381683,
        0.6419340038285408,
        0.6477952422300678,
        0.6536343098996595,
        0.6594503309200531,
        0.6652424328312085,
        0.6710097467611859,
        0.676751407556485,
        0.682466553911827,
        0.6881543284993582,
        0.6938138780972578,
        0.6994443537177295,
        0.7050449107343583,
        0.710614709008812,
        0.7161529130168707,
        0.7216586919737636,
        0.727131219958795,
        0.7325696760392397,
        0.7379732443934917,
        0.7433411144334452,
        0.7486724809260907,
        0.753966544114308,
        0.7592225098368373,
        0.7644395896474112,
        0.7696170009330296,
        0.7747539670313592,
        0.7798497173472405,
        0.7849034874682843,
        0.7899145192795415,
        0.7948820610772271,
        0.7998053676814841,
        0.804683700548167,
        0.8095163278796307,
        0.8143025247345075,
        0.8190415731364558,
        0.8237327621818624,
        0.8283753881464866,
        0.8329687545910243,
        0.8375121724655814,
        0.842004960213038,
        0.8464464438712884,
        0.8508359571743426,
        0.8551728416522717,
        0.8594564467299857,
        0.8636861298248261,
        0.8678612564429589,
        0.8719812002745557,
        0.876045343287746,
        0.8800530758213277,
        0.8840037966762229,
        0.8878969132056629,
        0.8917318414040919,
        0.895508005994773,
        0.8992248405160854,
        0.9028817874064994,
        0.9064782980882158,
        0.9100138330494585,
        0.9134878619254063,
        0.9168998635777524,
        0.9202493261728814,
        0.9235357472586481,
        0.9267586338397515,
        0.9299175024516881,
        0.9330118792332773,
        0.9360412999977441,
        0.9390053103023532,
        0.9419034655165792,
        0.9447353308888055,
        0.9475004816115422,
        0.9501985028851518,
        0.9528289899800724,
        0.9553915482975325,
        0.9578857934287452,
        0.9603113512125733,
        0.9626678577916581,
        0.9649549596670028,
        0.9671723137510015,
        0.9693195874189073,
        0.9713964585587312,
        0.9734026156195638,
        0.9753377576583142,
        0.9772015943848581,
        0.978993846205589,
        0.980714244265366,
        0.9823625304878532,
        0.9839384576142447,
        0.9854417892403715,
        0.9868722998521853,
        0.988229774859617,
        0.989514010628811,
        0.9907248145127322,
        0.9918620048801577,
        0.992925411143063,
        0.9939148737824304,
        0.9948302443725325,
        0.9956713856037915,
        0.996438171304411,
        0.9971304864612048,
        0.9977482272405482,
        0.9982913010116907,
        0.9987596263783605,
        0.9991531332365032,
        0.9994717629217045,
        0.9997154687331307,
        0.9998842187046316,
        0.9999780250094961,
    ]
)

_glw128 = jnp.array(
    [
        0.00022469048014465273,
        0.0005229063396721065,
        0.0008212515093340767,
        0.0011191442154818193,
        0.0014163757357295724,
        0.0017127630204553925,
        0.0020081274918696598,
        0.0023022921283518683,
        0.002595080916338365,
        0.002886318771432988,
        0.0031758315808534626,
        0.0034634462834493692,
        0.0037489909628172884,
        0.004032294945243044,
        0.004313188899308385,
        0.004591504935830139,
        0.004867076707503342,
        0.0051397395079161275,
        0.005409330369751429,
        0.005675688162040326,
        0.0059386536863699725,
        0.006198069771975295,
        0.006453781369633737,
        0.006705635644308129,
        0.006953482066475893,
        0.007197172502083266,
        0.007436561301073707,
        0.00767150538443266,
        0.007901864329699573,
        0.008127500454892538,
        0.008348278900794532,
        0.008564067711555613,
        0.008774737913558784,
        0.008980163592504383,
        0.009180221968665624,
        0.009374793470272366,
        0.009563761804975453,
        0.009747014029353275,
        0.009924440616415403,
        0.010095935521064935,
        0.010261396243480035,
        0.010420723890375492,
        0.010573823234110637,
        0.010720602769604206,
        0.010860974769026012,
        0.010994855334230213,
        0.01112216444689985,
        0.011242826016372425,
        0.011356767925118208,
        0.011463922071843373,
        0.01156422441219346,
        0.011657614997031345,
        0.011744038008267888,
        0.01182344179222377,
        0.011895778890501635,
        0.011961006068351675,
        0.012019084340511974,
        0.01206997899450959,
        0.012113659611407578,
        0.012150100083985883,
        0.012179278632345256,
        0.012201177816924737,
        0.01221578454892497,
        0.012223090098131212,
        0.012223090098131212,
        0.01221578454892497,
        0.012201177816924737,
        0.012179278632345256,
        0.012150100083985883,
        0.012113659611407578,
        0.01206997899450959,
        0.012019084340511974,
        0.011961006068351675,
        0.011895778890501635,
        0.01182344179222377,
        0.011744038008267888,
        0.011657614997031345,
        0.01156422441219346,
        0.011463922071843373,
        0.011356767925118208,
        0.011242826016372425,
        0.01112216444689985,
        0.010994855334230213,
        0.010860974769026012,
        0.010720602769604206,
        0.010573823234110637,
        0.010420723890375492,
        0.010261396243480035,
        0.010095935521064935,
        0.009924440616415403,
        0.009747014029353275,
        0.009563761804975453,
        0.009374793470272366,
        0.009180221968665624,
        0.008980163592504383,
        0.008774737913558784,
        0.008564067711555613,
        0.008348278900794532,
        0.008127500454892538,
        0.007901864329699573,
        0.00767150538443266,
        0.007436561301073707,
        0.007197172502083266,
        0.006953482066475893,
        0.006705635644308129,
        0.006453781369633737,
        0.006198069771975295,
        0.0059386536863699725,
        0.005675688162040326,
        0.005409330369751429,
        0.0051397395079161275,
        0.004867076707503342,
        0.004591504935830139,
        0.004313188899308385,
        0.004032294945243044,
        0.0037489909628172884,
        0.0034634462834493692,
        0.0031758315808534626,
        0.002886318771432988,
        0.002595080916338365,
        0.0023022921283518683,
        0.0020081274918696598,
        0.0017127630204553925,
        0.0014163757357295724,
        0.0011191442154818193,
        0.0008212515093340767,
        0.0005229063396721065,
        0.00022469048014465273,
    ]
)
_glw256 = jnp.array(
    [
        5.6394508908972135e-05,
        0.0001312674721481131,
        0.00020623162721254636,
        0.00028117447701618244,
        0.00035607708173627687,
        0.0004309268507101829,
        0.0005057121966039885,
        0.0005804217787837861,
        0.0006550443409510884,
        0.0007295686666559608,
        0.0008039835653748764,
        0.0008782778681657436,
        0.0009524404267494998,
        0.0010264601139829978,
        0.0011003258249201325,
        0.0011740264781636772,
        0.001247551017352091,
        0.0013208884127137632,
        0.0013940276626636535,
        0.0014669577954148712,
        0.0015396678705993222,
        0.0016121469808971528,
        0.0016843842536578592,
        0.0017563688525284013,
        0.0018280899790715046,
        0.0018995368743830762,
        0.001970698820704266,
        0.002041565143026118,
        0.0021121252106908947,
        0.0021823684389840736,
        0.0022522842907237934,
        0.0023218622778401546,
        0.0023910919629461717,
        0.0024599629609069547,
        0.0025284649403934673,
        0.002596587625434714,
        0.00266432079695792,
        0.002731654294322291,
        0.002798578016841412,
        0.002865081925300632,
        0.00293115604346124,
        0.0029967904595576147,
        0.00306197532778387,
        0.003126700869771087,
        0.0031909573760539197,
        0.003254735207526808,
        0.0033180247968906023,
        0.003380816650086978,
        0.003443101347723138,
        0.0035048695464848915,
        0.0035661119805376674,
        0.00362681946291692,
        0.0036869828869062595,
        0.0037465932274030438,
        0.0038056415422728918,
        0.0038641189736907324,
        0.003922016749469925,
        0.003979326184377149,
        0.004036038681436778,
        0.0040921457332191765,
        0.0041476389231176304,
        0.004202509926610775,
        0.004256750512511272,
        0.004310352544200585,
        0.004363307980849458,
        0.004415608878624394,
        0.004467247391879052,
        0.004518215774331394,
        0.004568506380225496,
        0.004618111665478231,
        0.0046670241888117,
        0.004715236612868862,
        0.004762741705314675,
        0.004809532339920354,
        0.004855601497633192,
        0.004900942267628759,
        0.004945547848347962,
        0.0049894115485174745,
        0.005032526788153249,
        0.0050748870995474624,
        0.005116486128239125,
        0.005157317633967025,
        0.005197375491605841,
        0.005236653692085195,
        0.005275146343290777,
        0.005312847670948326,
        0.005349752019489936,
        0.005385853852902337,
        0.005421147755557407,
        0.0054556284330245265,
        0.0054892907128648236,
        0.005522129545407008,
        0.005554140004504979,
        0.005585317288276758,
        0.005615656719824877,
        0.005645153747937792,
        0.005673803947772778,
        0.005701603021519624,
        0.005728546799045369,
        0.005754631238519775,
        0.005779852427021862,
        0.005804206581126579,
        0.00582769004747266,
        0.005850299303310381,
        0.0058720309570303,
        0.005892881748671755,
        0.005912848550412038,
        0.005931928367035568,
        0.005950118336383276,
        0.005967415729781823,
        0.005983817952452988,
        0.0059993225439029406,
        0.006013927178291311,
        0.006027629664780101,
        0.006040427947862306,
        0.006052320107670266,
        0.0060633043602636915,
        0.006073379057897267,
        0.0060825426892677755,
        0.006090793879740916,
        0.006098131391557393,
        0.00610455412401866,
        0.006110061113652013,
        0.006114651534355177,
        0.006118324697520115,
        0.0061210800521364515,
        0.006122917184873994,
        0.006123835820144911,
        0.006123835820144911,
        0.006122917184873994,
        0.0061210800521364515,
        0.006118324697520115,
        0.006114651534355177,
        0.006110061113652013,
        0.00610455412401866,
        0.006098131391557393,
        0.006090793879740916,
        0.0060825426892677755,
        0.006073379057897267,
        0.0060633043602636915,
        0.006052320107670266,
        0.006040427947862306,
        0.006027629664780101,
        0.006013927178291311,
        0.0059993225439029406,
        0.005983817952452988,
        0.005967415729781823,
        0.005950118336383276,
        0.005931928367035568,
        0.005912848550412038,
        0.005892881748671755,
        0.0058720309570303,
        0.005850299303310381,
        0.00582769004747266,
        0.005804206581126579,
        0.005779852427021862,
        0.005754631238519775,
        0.005728546799045369,
        0.005701603021519624,
        0.005673803947772778,
        0.005645153747937792,
        0.005615656719824877,
        0.005585317288276758,
        0.005554140004504979,
        0.005522129545407008,
        0.0054892907128648236,
        0.0054556284330245265,
        0.005421147755557407,
        0.005385853852902337,
        0.005349752019489936,
        0.005312847670948326,
        0.005275146343290777,
        0.005236653692085195,
        0.005197375491605841,
        0.005157317633967025,
        0.005116486128239125,
        0.0050748870995474624,
        0.005032526788153249,
        0.0049894115485174745,
        0.004945547848347962,
        0.004900942267628759,
        0.004855601497633192,
        0.004809532339920354,
        0.004762741705314675,
        0.004715236612868862,
        0.0046670241888117,
        0.004618111665478231,
        0.004568506380225496,
        0.004518215774331394,
        0.004467247391879052,
        0.004415608878624394,
        0.004363307980849458,
        0.004310352544200585,
        0.004256750512511272,
        0.004202509926610775,
        0.0041476389231176304,
        0.0040921457332191765,
        0.004036038681436778,
        0.003979326184377149,
        0.003922016749469925,
        0.0038641189736907324,
        0.0038056415422728918,
        0.0037465932274030438,
        0.0036869828869062595,
        0.00362681946291692,
        0.0035661119805376674,
        0.0035048695464848915,
        0.003443101347723138,
        0.003380816650086978,
        0.0033180247968906023,
        0.003254735207526808,
        0.0031909573760539197,
        0.003126700869771087,
        0.00306197532778387,
        0.0029967904595576147,
        0.00293115604346124,
        0.002865081925300632,
        0.002798578016841412,
        0.002731654294322291,
        0.00266432079695792,
        0.002596587625434714,
        0.0025284649403934673,
        0.0024599629609069547,
        0.0023910919629461717,
        0.0023218622778401546,
        0.0022522842907237934,
        0.0021823684389840736,
        0.0021121252106908947,
        0.002041565143026118,
        0.001970698820704266,
        0.0018995368743830762,
        0.0018280899790715046,
        0.0017563688525284013,
        0.0016843842536578592,
        0.0016121469808971528,
        0.0015396678705993222,
        0.0014669577954148712,
        0.0013940276626636535,
        0.0013208884127137632,
        0.001247551017352091,
        0.0011740264781636772,
        0.0011003258249201325,
        0.0010264601139829978,
        0.0009524404267494998,
        0.0008782778681657436,
        0.0008039835653748764,
        0.0007295686666559608,
        0.0006550443409510884,
        0.0005804217787837861,
        0.0005057121966039885,
        0.0004309268507101829,
        0.00035607708173627687,
        0.00028117447701618244,
        0.00020623162721254636,
        0.0001312674721481131,
        5.6394508908972135e-05,
    ]
)
glx128 = _glx128
glw128 = _glw128
glx256 = _glx256
glw256 = _glw256


def quad(f, a, b):
    """
    Fixed order Gauss-Legendre quadrature for integration of f(x)
    from x=a to x=b
    """
    x_i = a + (b - a) * _glx256
    return cond(b == a, lambda x_i: 0.0, lambda x_i: (b - a) * f(x_i) @ _glw256, x_i)
